/*! wdb 2019-09-16 */

var Log,create_socket,get_proc_thread_val,make_brk_line,make_process_line,make_thread_line,make_uuid_line,null_if_void,rm_brk_line,rm_uuid_line,wait,ws,ws_message,indexOf=[].indexOf||function(t){for(var e=0,n=this.length;e<n;e++)if(e in this&&this[e]===t)return e;return-1};Log=function(){function t(){this.debug=$("body").attr("data-debug")||!1}return t.prototype.time=function(){var t;return(t=new Date).getHours()+":"+t.getMinutes()+":"+t.getSeconds()+"."+t.getMilliseconds()},t.prototype.log=function(){var t;if(this.debug)return t=["["+this.constructor.name+"] ("+this.time()+")"].concat(Array.prototype.slice.call(arguments,0)),console.log.apply(console,t)},t.prototype.dbg=function(){var t;if(this.debug)return t=["["+this.constructor.name+"] ("+this.time()+")"].concat(Array.prototype.slice.call(arguments,0)),console.debug.apply(console,t)},t.prototype.fail=function(){var t;return t=[this.constructor.name].concat(Array.prototype.slice.call(arguments,0)),console.error.apply(console,t)},t}(),ws=null,wait=25,make_uuid_line=function(t,e,n){var o;if(n=n||"",(o=$(".sessions tr[data-uuid="+t+"]")).length||(o=$('<tr data-uuid="'+t+'"> <td class="uuid mdl-data-table__cell--non-numeric"> <a href="/debug/session/'+t+'">'+t+'</a> </td> <td class="socket mdl-data-table__cell--non-numeric">No</td> <td class="websocket mdl-data-table__cell--non-numeric">No</td> <td class="action"> <button class="mdl-button mdl-js-button mdl-button--icon close mdl-button--colored" title="Force close"> <i class="material-icons">close</i> </button> </td>'),$(".sessions .filename-head").length&&o.prepend('<td class="filename mdl-data-table__cell--non-numeric"> <span>'+n+"</span> </td>"),$(".sessions tbody").append(o)),o.find("."+e).text("Yes"),n)return o.find(".filename span").text(n)},rm_uuid_line=function(t,e){var n;if((n=$(".sessions tr[data-uuid="+t+"]")).length)return"socket"===e&&"No"===n.find(".websocket").text()||"websocket"===e&&"No"===n.find(".socket").text()?n.remove():n.find("."+e).text("No")},make_brk_line=function(t){var e,n,o,s,r;for(s="<tr>",n=0,o=(r=["fn","lno","cond","fun"]).length;n<o;n++)s+='<td class="'+(e=r[n])+'">'+(t[e]||"∅")+"</td>";return s+='<td class="action"> <button class="mdl-button mdl-js-button mdl-button--icon open mdl-button--colored" title="Open"> <i class="material-icons">open_in_new</i> </button> <button class="mdl-button mdl-js-button mdl-button--icon delete mdl-button--colored" title="Remove"> <i class="material-icons">delete</i> </button> </td>',s+="</tr>",$(".breakpoints tbody").append($(s))},rm_brk_line=function(t){var e,n,o,s,r,a,i,d,l,c,u;for(l=[],o=0,r=(i=$(".breakpoints tr")).length;o<r;o++){for(u=i[o],e=$(u),c=!0,s=0,a=(d=["fn","lno","cond","fun"]).length;s<a;s++)n=d[s],c=c&&e.find("."+n).text()===""+(t[n]||"∅");c?l.push(e.remove()):l.push(void 0)}return l},get_proc_thread_val=function(t,e){var n,o,s,r,a,i;if(null==(i=t[e]))return"∅";if("time"===e)i=function(t){var e,n;return n=Math.floor((new Date-t)/1e3),1<(e=Math.floor(n/31536e3))?e+"y":1<(e=Math.floor(n/2592e3))?e+"mo":1<(e=Math.floor(n/86400))?e+"d":1<(e=Math.floor(n/3600))?e+"h":1<(e=Math.floor(n/60))?e+"m":Math.floor(n)+"s"}(1e3*i);else if("mem"===e||"cpu"===e)i=i.toFixed(2)+"%";else if("cmd"===e){for(r=[],n=0,o=(a=i.split(" ")).length;n<o;n++)0===(s=a[n]).indexOf("/")?r.push('<abbr title="'+s+'">'+s.split("/").slice(-1)+"</abbr>"):1===s.indexOf(":")&&2===s.indexOf("\\")?r.push('<abbr title="'+s+'"> '+s.slice(3).split("\\").slice(-1)+"</abbr>"):r.push(s);i=r.join(" ")}return i},make_process_line=function(t){var e,n,o,s,r,a,i,d,l,c;if((e=$(".processes tbody tr[data-pid="+t.pid+"]")).length){for(c=[],o=0,r=(d=["pid","user","cmd","time","mem","cpu"]).length;o<r;o++)n=d[o],c.push(e.find("."+n).html(get_proc_thread_val(t,n)));return c}for(i='<tr data-pid="'+t.pid+'" '+(t.threadof?'data-threadof="'+t.threadof+'"':"")+">",s=0,a=(l=["pid","user","cmd","time","mem","cpu"]).length;s<a;s++)i+='<td class="rowspan '+(n=l[s])+'"> '+get_proc_thread_val(t,n)+"</td>";return i+='  <td class="action">\n    <button class="mdl-button mdl-js-button mdl-button--icon plus mdl-button--colored" title="Toggle threads">\n      <i class="material-icons">add</i>\n    </button>\n  </td>\n  <td class="action">\n    <button class="mdl-button mdl-js-button mdl-button--icon pause mdl-button--colored" title="Pause">\n      <i class="material-icons">pause</i>\n    </button>\n  </td>\n</tr>',$(".processes tbody").append($(i))},make_thread_line=function(t){var e,n,o,s,r,a,i,d,l;if((n=$(".processes tbody tr[data-pid="+t.of+"]")).length){if((o=$(".processes tbody tr[data-tid="+t.id+"]")).length){for(l=[],r=0,a=(d=["id","of"]).length;r<a;r++)s=d[r],l.push(o.find("."+s).text(get_proc_thread_val(t,s)));return l}return i='<tr data-tid="'+t.id+'" data-of="'+t.of+'"\n  style="display: none">\n  <td class="id">'+get_proc_thread_val(t,"id")+'</td>\n  <td class="action">\n    <button class="mdl-button mdl-js-button mdl-button--icon pause mdl-button--colored" title="Pause">\n      <i class="material-icons">pause</i>\n    </button>\n  </td>\n</tr>',(e=n.nextAll("[data-pid]")).length?e.before(i):$(".processes tbody").append(i)}},ws_message=function(t){var e,n,o,s,r,a,i,d,l,c,u,p,f,m,b,_,h;switch(wait=25,s=-1<(c=(l=t.data).indexOf("|"))?(o=l.substr(0,c),JSON.parse(l.substr(c+1))):(o=l,""),o){case"AddWebSocket":return make_uuid_line(s,"websocket");case"AddSocket":return make_uuid_line(s.uuid,"socket",s.filename);case"RemoveWebSocket":return rm_uuid_line(s,"websocket");case"RemoveSocket":return rm_uuid_line(s,"socket");case"AddBreak":return make_brk_line(s);case"RemoveBreak":return rm_brk_line(s);case"AddProcess":return make_process_line(s);case"AddThread":return make_thread_line(s);case"KeepProcess":for(b=[],r=0,i=(u=$(".processes tbody tr[data-pid]")).length;r<i;r++)h=u[r],n=$(h),p=parseInt(n.attr("data-pid")),indexOf.call(s,p)<0?($(".processes [data-of="+n.attr("data-pid")+"]").remove(),b.push(n.remove())):b.push(void 0);return b;case"KeepProcess":for(_=[],a=0,d=(f=$(".processes tbody tr[data-tid]")).length;a<d;a++)h=f[a],n=$(h),m=parseInt(n.attr("data-tid")),indexOf.call(s,m)<0?(n.remove(),e=$(".processes [data-pid="+n.attr("data-of")+"]"),_.push(e.attr("rowspan",+e.attr("rowspan")-1))):_.push(void 0);return _;case"StartLoop":return setInterval(function(){return ws.send("ListProcesses")},2e3)}},create_socket=function(){var t;return t="https:"===document.location.protocol?"wss:":"ws:",(ws=new WebSocket(t+"//"+location.host+"/status")).onopen=function(){return $("tbody tr").remove(),ws.send("ListSockets"),ws.send("ListWebSockets"),ws.send("ListBreaks"),ws.send("ListProcesses")},ws.onerror=function(){},ws.onmessage=ws_message,ws.onclose=function(){return wait*=2,setTimeout(create_socket,wait)}},null_if_void=function(t){return"∅"===t?null:t},$(function(){return create_socket(),$(".sessions tbody").on("click",".close",function(t){return ws.send("RemoveUUID|"+$(this).closest("tr").attr("data-uuid")),!1}),$(".breakpoints tbody").on("click",".open",function(t){var e;return e=$(this).closest("tr"),ws.send("RunFile|"+e.find(".fn").text()),!1}),$(".breakpoints tbody").on("click",".delete",function(t){var e,n;return n={fn:(e=$(this).closest("tr")).find(".fn").text(),lno:parseInt(e.find(".lno").text()),cond:null_if_void(e.find(".cond").text()),fun:null_if_void(e.find(".fun").text())},ws.send("RemoveBreak|"+JSON.stringify(n)),!1}),$(".processes tbody").on("click",".pause",function(t){var e;return e=$(this).closest("tr"),ws.send("Pause|"+(e.attr("data-pid")||e.attr("data-tid"))),!1}).on("click",".minus",function(t){var e,n;return n=(e=$(this)).closest("tr"),$("[data-of="+n.attr("data-pid")+"]").hide(),n.find(".rowspan").attr("rowspan",1),e.removeClass("minus").addClass("plus").find("i").text("add"),!1}).on("click",".plus",function(t){var e,n,o;return n=(e=$(this)).closest("tr"),o=$("[data-of="+n.attr("data-pid")+"]").show().length,n.find(".rowspan").attr("rowspan",o+1),e.removeClass("plus").addClass("minus").find("i").text("remove"),!1}),$(".runfile").on("submit",function(){return ws.send("RunFile|"+$(this).find("[type=text]").val()),!1}),$(".open-shell button").on("click",function(t){return ws.send("RunShell")})});